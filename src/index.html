<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>WebGPU-Notes</title>
    <style>
        html {
            font-size: 10px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #383838;
            color: #fff;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }

        pre {
            overflow-x: auto;
            border-radius: 0.6rem;
        }

        iframe {
            border: none;
            overflow: hidden;
            width: 40rem;
            height: 30rem;
        }

        a {
            /* 去掉默认的下划线 */
            text-decoration: none;
            color: #ec3d95;
            position: relative;
        }

        a::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -2px;
            width: 100%;
            height: 2px;
            background: #f3267c;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: right;
        }

        a:hover::after {
            transform: scaleX(1);
            transform-origin: left;
        }

        input[type="text"] {
            width: 20rem;
            height: 2.5rem;
            border: 0.2rem solid #ddd;
            border-radius: 0.8rem;
            font-size: 1.4rem;
            outline: none;
            transition: all 0.3s ease;
            background: #fff;
            box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        input[type="text"]:focus {
            border-color: #c43393;
            box-shadow: 0 0 0.8rem rgba(156, 35, 82, 0.5);
        }

        input[type="text"]::placeholder {
            color: #aaa;
            font-style: italic;
        }

        button {
            padding: 0.7rem 1.2rem;
            font-weight: bold;
            color: #fff;
            border: none;
            border-radius: 0.6rem;
            background: linear-gradient(135deg, #ff7eb3, #a18cd1);
            backdrop-filter: blur(1rem);
            box-shadow: 0 0.4rem 2rem rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            opacity: 0.8;
            transform: translateY(-0.2rem);
            box-shadow: 0 0.6rem 2.5rem rgba(0, 0, 0, 0.25);
        }

        button:active {
            transform: translateY(1px);
            box-shadow: 0 0.3rem 1rem rgba(0, 0, 0, 0.3);
        }

        dialog {
            box-sizing: content-box;
            padding: 2rem;
            min-width: 50%;
            width: fit-content;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.8rem 2.4rem rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(1rem);
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.4);
        }

        #header {
            position: sticky;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 5rem;
            background: #1a1a1a;
        }

        #search {
            display: flex;
            align-items: center;
        }

        #content {
            margin: 3rem;
            padding: 2rem;
            max-width: 90rem;
            background: #252525;
            border-radius: 0.8rem;
            box-shadow: 0 0.2rem 0.6rem rgba(0, 0, 0, 0.2);
        }
    </style>
    <!-- 引入 marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 白天模式 -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/default.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/atom-one-light.min.css"> -->
    <!-- 夜间模式 -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/monokai.min.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github-dark.min.css"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/atom-one-dark.min.css">
    <!-- 引入 highlight.js -->
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/languages/go.min.js"></script>
</head>

<body>
    <header id="header">
        <div></div>
        <div id="search">
            <input type="text" placeholder="搜索...">
            <button style="margin-left: 0.5rem;">搜索</button>
        </div>
    </header>
    <div id="content"></div>
    <dialog id="dialog">
        <h2>搜索结果</h2>
        <ul id="search-result">
            <li><a href="#">WebGPU 简介</a></li>
            <li><a href="#">WebGPU 基本概念</a></li>
            <li><a href="#">WebGPU 编程模型</a></li>
            <li><a href="#">WebGPU 工作组</a></li>
            <li><a href="#">WebGPU 管线</a></li>
            <li><a href="#">WebGPU 资源绑定</a></li>
            <li><a href="#">WebGPU 资源管理</a></li>
            <li><a href="#">WebGPU 着色器</a></li>
            <li><a href="#">WebGPU 计算</a></li>
            <li><a href="#">WebGPU 存储</a></li>
        </ul>
    </dialog>
    <script src="./assets/js/utils.js"></script>
    <script>
        // 配置 marked 使用 highlight.js 
        marked.setOptions({
            highlight: function (code, lang) {
                // 如果指定了语言，尝试用对应的高亮 
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                // 否则自动检测 
                return hljs.highlightAuto(code).value;
            }
        });
        // const renderer = new marked.Renderer();
        // // 重写 link 方法 
        // renderer.link = function (o) { return `<a href="${o.href}" target="_blank" rel="noopener noreferrer">${o.text}</a>`; };
        // // 使用自定义 renderer 
        // marked.setOptions({ renderer });
        function parseMarkdown(url = './docs/webgpu.md') {
            // 读取并渲染 md 文件
            readMarkDown(url).then(text => {
                // 使用 marked 将 Markdown 转换为 HTML
                document.getElementById('content').innerHTML = marked.parse(text);

                // 对所有代码块执行高亮
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            })
        }

        // 1. 定义路由表
        const routes = {
            '#/docs/webgpu.md': './docs/webgpu.md',
            '#/docs/details/1-Triangle.md': './docs/details/1-Triangle.md',
        };

        // 2. 路由渲染函数
        function router() {
            const content = document.getElementById('content');
            // 获取当前的 hash，如果没有则默认跳转到首页
            const path = window.location.hash || '#/docs/webgpu.md';
            const url = routes[path] || path.replace('#/', './');
            // 根据 hash 渲染对应的 HTML
            content.innerHTML = parseMarkdown(url);
        }

        // 3. 监听 hash 变化
        window.addEventListener('hashchange', router);

        // 4. 页面首次加载时执行一次
        window.addEventListener('load', router);

        // 搜索功能
        async function search(keyword) {
            const mds = []
            const targets = []
            for (const key in routes) {
                const url = routes[key];
                const text = await readMarkDown(url);
                const md = { url, text }
                mds.push(md)
            }
            for (const md of mds) {
                const text = md.text;
                const results = getKeywordContext(text, keyword, 10)
                for (const result of results) {
                    const target = {...md, ...result }
                    targets.push(target)
                }
            }
            return targets;
        }
        const searchInput = document.querySelector('#search input');
        const searchButton = document.querySelector('#search button');
        const dialog = document.querySelector('#dialog');
        const ul = document.querySelector('#search-result');
        addEventListener('click', (event) => {
            if (event.target === dialog) {
                dialog.close();
            }
        });
        searchButton.addEventListener('click', async () => {
            const keyword = searchInput.value.trim();
            if (keyword) {
                dialog.showModal(); // showModal() 表示模态对话框
                const mds = await search(keyword)
                ul.innerHTML = '';
                for (const md of mds) {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = md.url.replace('./', '#/');
                    a.innerHTML =  `${md.url}: ${md.before}<b style="color: #f00;">${md.keyword}</b>${md.after}`;
                    li.appendChild(a);
                    ul.appendChild(li);
                }
            }
        });
    </script>
</body>

</html>